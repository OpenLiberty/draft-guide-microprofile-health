// Copyright (c) 2018 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: microprofile-health
:page-layout: guide
:page-duration: 20 minutes
:page-releasedate: 2018-03-09
:page-description: Learn how to provide and check the health of a microservice using MicroProfile Health.
:page-tags: ['CDI', 'REST', 'HealthCheck', 'MicroProfile', '@Health', 'Config', 'ConfigProperty', 'microservices']
:page-permalink: /guides/{projectid}
:page-related-guides: ['microprofile-config', 'microprofile-metrics', 'cdi-intro', 'rest-intro']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/master
:source-highlighter: prettify
= Adding health reports to a microservice

Youâ€™ll explore how to check the health of a microservice with MicroProfile Health.

// =================================================================================================
//  What you'll learn
// =================================================================================================

== What you'll learn

You will learn how to use the MicroProfile Health to report the health of
a microservice. A health check allows your microservice to participate in the decision-making process about its health.

The MicroProfile Health provides an endpoint that includes the health check results as a
JSON object. This HTTP request endpoint returns a status code of `200` if the application outcome
is `UP`. Otherwise, the endpoint returns a status code of `503` if the application outcome is `DOWN`.

You will use the health check to assess the state of a service in an application. The state of a service
is either `UP` or `DOWN`. When the state is `UP`, the service is available.
When the state is `DOWN`, the service is either unavailable or in maintenance.
The overall outcome of the application is `UP` only when the checks of all the services are `UP`.
A service orchestrator can use a `DOWN` result to determine when to replace an instance of a service.

Before the service reports its state, it checks what it needs to make available. Depending on
what the service has or what is provided to it, it can use the MicroProfile Health API implementation to report whether it is healthy or not. A self-check can be anything that is related to the
service, such as a dependency, a successful connection to an endpoint, a system property, a database, or another availability
of resources.

You will add health checks to report the states of the `system` and `inventory`
microservices in an inventory manager application. This application and the microservices in it
are provided for you. To learn how to create microservices, see
https://openliberty.io/guides/rest-intro.html[Creating a RESTful web service].

// =================================================================================================
// Getting Started
// =================================================================================================

include::{common-includes}/gitclone.adoc[]

// =================================================================================================
// Try what you'll build
// =================================================================================================

=== Try what you'll build

The `finish` directory in the root file contains the finished
health check implementation for the services in the application. You can try out the application before
you build your own.

To try the application, navigate to the `finish` directory. Next, execute the following
Maven goals to build the application and run it inside of Open Liberty:

```
mvn install liberty:start-server
```

You can access two microservices to test their availability. The
`http://localhost:9080/inventory/systems/localhost` URL retrieves the information for a specific host. The
`http://localhost:9080/inventory/systems` URL retrieves the information for a list of all previously
registered hosts.

Next, go to `http://localhost:9080/health` URL to see the health of the two services as well as the overall
health outcome of the application. One check shows the state of the `system` service, and the other shows the state of
the `inventory` service. As you might expect, both services are in the `UP` state, and the overall outcome of
the application is `UP`.

[source, role="no_copy"]
----
{
  "checks": [
      {
        "data": {
           "services": "available"
        },
        "name": "InventoryResource",
        "state": "UP"
      },
      {
        "data": {
           "default server": "available"
        },
        "name": "SystemResource",
        "state": "UP"
      }
   ],
   "outcome": "UP"
}
----

When you're done checking out the application, stop the Open Liberty server with the following
command:

```
mvn liberty:stop-server
```

Navigate back to the `start` directory to begin.

// =================================================================================================
// Adding health checks to microservice
// =================================================================================================

== Adding health checks to microservices

Navigate to the `pom.xml` file to check the required dependency. The `microprofile-health-api`
dependency is located in the `pom.xml` file. With this dependency, you can
use the MicroProfile Health API to provide health checks to your microservices.
The `mpHealth-1.0` feature is enabled in the `src/main/liberty/config/server.xml` file.

// =================================================================================================
// Adding a health check to the system service
// =================================================================================================

=== Adding a health check to the system service

Create health check class for the `system` service in the
`src/main/java/io/openliberty/guides/system/SystemHealth.java` file:

[source, java, indent=0]
----
include::finish/src/main/java/io/openliberty/guides/system/SystemHealth.java[tags=SystemHealth]
----

The `org.eclipse.microprofile` package contains the required MicroProfile Health Check classes.

The `@Health` annotation indicates that this class reports the state of
`system` service through `http://localhost:9080/health` URL. The `@ApplicationScoped` annotation is
required because the health check service must stay active within the lifetime of the application
to report the state.

This class implements the `HealthCheck` interface from MicroProfile Health API. The `call()` method from the
interface is implemented to report the state of the service by returning a `HealthCheckResponse` object.

The `system` service self-checks. It reads the system property of the host to report a healthy state.
If the `wlp.server.name` system property is `defaultServer`, the state is `UP`. Otherwise, the state is `DOWN`.

Lastly, the `named()` method from the interface needs to indicate the service to report the health, thus,
passing the `system` service name as an argument.

// =================================================================================================
// Adding a health check to the inventory service
// =================================================================================================

=== Adding a health check to the inventory service

Create health check class for the `inventory` service in the
`src/main/java/io/openliberty/guides/inventory/InventoryHealth.java` file:

[source, java, indent=0]
----
include::finish/src/main/java/io/openliberty/guides/inventory/InventoryHealth.java[tags=InventoryHealth]
----

This service reports a healthy state based on two factors:

1- Configure the provided property of type boolean, which is shown in the `resources/CustomConfigSource.json` file.
The `InventoryConfig` object reads the property in this file, which manipulates the state of the service.

[source, role="no_copy"]
----
"io.openliberty.guides.microprofile.inventory.inMaintenance": false
----

To learn how to configure the file, see https://openliberty.io/guides/microprofile-config.html[Configuring microservices].

2- Check that the `system` service availability returns a `200` response code.

The `@Inject` annotation is used to initialize the `InventoryConfig` object. This object allows
you to read the property in the `resources/CustomConfigSource.json` file. Learn more about the
`@Inject` annotation from
https://openliberty.io/guides/cdi-intro.html[Injecting dependencies into microservices].

The `isHealthy()` method returns a boolean that determines the health of the `inventory` service. This method checks the
two previous factors. The `call()`` method uses the `isHealthy()` method to determine the state of the inventory service.
The state is `UP` if the `isHealthy()` method returns `true`. Otherwise, it is `DOWN`.

Now, open the `inventory` service from the `src/main/java/io/openliberty/guides/inventory/InventoryResource.java` file:

[source, java, indent=0]
----
include::finish/src/main/java/io/openliberty/guides/inventory/InventoryResource.java[tags=InventoryResource]
----

The `getPropertiesForHost()` method displays the system properties for a host name only if you set the
`io.openliberty.guides.microprofile.inventory.inMaintenance` property to `false`. If this is the case,
then the health of this service is `UP`.

Otherwise, if the property is set to `true`, the service responds with a `ERROR: Service is currently in maintenance. Please contact: admin@guides.openliberty.io`
message and a `503` response code. Thus, If the service is down for maintenance, its health is
`DOWN'.

Notice that the `isHealthy()` method of the `InventoryHealth` class
works with `getPropertiesForHost()` method through `InventoryConfig` object that modifies
the same configuration file `resources/CustomConfigSource.json`.

The same conditions apply to the `listContents()` method in this service. This method lists
the stored hosts.

// =================================================================================================
// Building and running the application
// =================================================================================================

include::{common-includes}/mvnbuild.adoc[]

While the server is running, navigate to the following URL to find the health endpoint
that reports the state of the two services:

* `http://localhost:9080/health`

Now, turn the `inventory` service down to simulate that it is in maintenance or that something went wrong. In
the `resources/CustomConfigSource.json` file, change the
`io_openliberty_guides_inventory_inMaintenance` property value to `true`. Refresh the browser. The state of the
`inventory` service is `DOWN`, so the overall outcome is `DOWN`.
To verify the states, point to the `http://localhost:9080/inventory/systems` `inventory` service URL.
The service responds with a message that it is in maintenance.

After you try out your application, go to the `resources/CustomConfigProperties.json` file again.
Change the `io_openliberty_guides_inventory_inMaintenance` property from `true` to `false` to set this condition back to its original value.

include::{common-includes}/mvnpackage.adoc[]

// =================================================================================================
// Testing health checks
// =================================================================================================

== Testing health checks

You will implement two test methods, `testIfServicesAreUp()` and `testIfInventoryServiceIsDown()`, to
validate the health of the inventory manager application with the `system` and
`inventory` services.

Begin by creating health check test class for the two services
in the `/src/test/java/it/io/openliberty/guides/health/HealthTest.java` file:

[source, java, indent=0]
----
include::finish/src/test/java/it/io/openliberty/guides/health/HealthTest.java[tags=HealthTest]
----

Use the `static` keyword with curly brackets, {}, to initialize the static fields. Static fields include the
`JsonArray` field, which holds the states of the services and the two maps for storing the states when the
services are up and when they are down, and the constant to hold the property that is read.

Place the `@After` annotation on methods that execute after every test case. These methods are
generally used to perform teardown tasks. In this case, the `teardown()` method simply resets
the property value.

A few test case methods include the `@Test` annotation to test functionality of the inventory
application after you add health checks.

* The `testIfServicesAreUp()` test case sends a request to the `http://localhost:9080/health` URL through the
`connectToHealthEndpoint()` method from the `HealthTestUtil class`. This util method also verifies a `200` response code. If
the request and verification are successful, then the util method returns the health result of the two services in
`JsonArray` format. This result is asserted with the expected data when services are up through the `checkServicesStates()`
private method. This private method uses the `getActualState()` method from the `HealthTestUtil` class to parse the actual
state of each services in the `JsonArray` result."

* The `testIfInventoryServiceIsDown()` method follows a procedure similar to the previous test case. The method first
checks if the `services` states are `UP`. Next, the `io.openliberty.guides.microprofile.inventory.inMaintenance` property
value is changed from `false` to `true` in the `resources/CustomConfigSource.json` file. With the property update, the
method sends a request to check the service states again. This time, the expected response code is `503`.
Lastly, the method asserts whether the state of the `inventory` service is `DOWN` and the state of the
`system` service is `UP`.

In addition, a few endpoint tests `src/test/java/it/io/openliberty/guides/inventory/InventoryEndpointTest.java`
and `src/test/java/it/io/openliberty/guides/system/SystemEndpointTest.java` are provided for you to
test the basic functionality of the `inventory` and `system` services. If a test failure occurs, then you might have
introduced a bug into the code.

// =================================================================================================
// Running the tests
// =================================================================================================

include::{common-includes}/mvnverify.adoc[]

[source, role="no_copy"]
----
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running it.io.openliberty.guides.health.HealthTest
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 3.504 sec - in it.io.openliberty.guides.health.HealthTest
Running it.io.openliberty.guides.inventory.InventoryEndpointTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.326 sec - in it.io.openliberty.guides.inventory.InventoryEndpointTest
Running it.io.openliberty.guides.system.SystemEndpointTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.011 sec - in it.io.openliberty.guides.system.SystemEndpointTest

Results :

Tests run: 4, Failures: 0, Errors: 0, Skipped: 0
----

To see whether the tests detect a failure, change the values of the tests maps inside the `static`
braces, {}. Rerun the Maven build. You see a test failure occur.

// =================================================================================================
// Great work! You're done!
// =================================================================================================

== Great work! You're done!

You learned how to add health checks to report the states of microservices in an
application. Then, you wrote tests to validate the checks.

You can continue to try one of the related guides, which demonstrate new technologies that you can learn and
expand on top what you built in this guide.

include::{common-includes}/finish.adoc[]
